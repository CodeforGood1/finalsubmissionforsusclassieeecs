version: '3.8'

# ============================================================
# SUSTAINABLE CLASSROOM - LOCAL DEVELOPMENT STACK
# ============================================================
# Simplified version for quick local testing
# Supports offline code execution with Python, Java, C++
# Run: docker-compose -f docker-compose.local.yml up -d
# ============================================================

services:
  # ============================================================
  # PostgreSQL Database
  # ============================================================
  postgres:
    image: postgres:15-alpine
    container_name: lms-db
    environment:
      POSTGRES_USER: ${DB_USER:-lms_admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-CHANGEME}
      POSTGRES_DB: ${DB_NAME:-sustainable_classroom}
    ports:
      - "5432:5432"
    volumes:
      - postgres_local:/var/lib/postgresql/data
      # Auto-initialize schema
      - ./backend/FRESH-COMPLETE-DATABASE.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./backend/add-module-progress-tracking.sql:/docker-entrypoint-initdb.d/02-modules.sql:ro
      - ./backend/add-coding-submissions.sql:/docker-entrypoint-initdb.d/03-coding.sql:ro
      - ./backend/add-inapp-notifications-table.sql:/docker-entrypoint-initdb.d/04-notifications.sql:ro
      - ./backend/add-chat-tables.sql:/docker-entrypoint-initdb.d/05-chat.sql:ro
      - ./backend/v2.2.6-multi-section.sql:/docker-entrypoint-initdb.d/06-multi-section.sql:ro
      - ./backend/notification-system.sql:/docker-entrypoint-initdb.d/07-notification-system.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-lms_admin} -d ${DB_NAME:-sustainable_classroom}"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - lms-local

  # ============================================================
  # MailHog (Local Email - view at http://localhost:8025)
  # ============================================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: lms-mail
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - lms-local

  # ============================================================
  # Jitsi Meet (Local Video Conferencing)
  # ============================================================
  jitsi-web:
    image: jitsi/web:stable-8719
    container_name: lms-jitsi-web
    ports:
      - "8443:443"
    environment:
      - ENABLE_AUTH=0
      - ENABLE_GUESTS=1
      - ENABLE_TRANSCRIPTIONS=0
      - DISABLE_HTTPS=0
      - JICOFO_AUTH_USER=focus
      - PUBLIC_URL=https://localhost:8443
      - TZ=UTC
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_BOSH_URL_BASE=http://jitsi-prosody:5280
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_GUEST_DOMAIN=guest.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_RECORDER_DOMAIN=recorder.meet.jitsi
    volumes:
      - jitsi_web_config:/config
      - jitsi_web_certs:/config/keys
    depends_on:
      - jitsi-prosody
    networks:
      lms-local:
        aliases:
          - meet.jitsi
    restart: unless-stopped

  jitsi-prosody:
    image: jitsi/prosody:stable-8719
    container_name: lms-jitsi-prosody
    expose:
      - "5222"
      - "5347"
      - "5280"
    environment:
      - AUTH_TYPE=internal
      - ENABLE_AUTH=0
      - ENABLE_GUESTS=1
      - ENABLE_LOBBY=1
      - ENABLE_XMPP_WEBSOCKET=1
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD:-CHANGEME}
      - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET:-CHANGEME}
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD:-CHANGEME}
      - PUBLIC_URL=https://localhost:8443
      - TZ=UTC
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_GUEST_DOMAIN=guest.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_INTERNAL_MUC_MODULES=muc_hide_all
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_MUC_MODULES=muc_meeting_id
      - XMPP_RECORDER_DOMAIN=recorder.meet.jitsi
    volumes:
      - jitsi_prosody_config:/config
    networks:
      lms-local:
        aliases:
          - xmpp.meet.jitsi
    restart: unless-stopped

  jitsi-jicofo:
    image: jitsi/jicofo:stable-8719
    container_name: lms-jitsi-jicofo
    environment:
      - AUTH_TYPE=internal
      - ENABLE_AUTH=0
      - ENABLE_AUTO_OWNER=1
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD:-CHANGEME}
      - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET:-CHANGEME}
      - TZ=UTC
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_SERVER=jitsi-prosody
    depends_on:
      - jitsi-prosody
    volumes:
      - jitsi_jicofo_config:/config
    networks:
      - lms-local
    restart: unless-stopped

  jitsi-jvb:
    image: jitsi/jvb:stable-8719
    container_name: lms-jitsi-jvb
    ports:
      - "10000:10000/udp"
      - "4443:4443"
    environment:
      - DOCKER_HOST_ADDRESS=127.0.0.1
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD:-CHANGEME}
      - JVB_BREWERY_MUC=jvbbrewery
      - JVB_PORT=10000
      - JVB_STUN_SERVERS=stun.l.google.com:19302,stun1.l.google.com:19302
      - PUBLIC_URL=https://localhost:8443
      - TZ=UTC
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_SERVER=jitsi-prosody
    depends_on:
      - jitsi-prosody
    volumes:
      - jitsi_jvb_config:/config
    networks:
      - lms-local
    restart: unless-stopped

volumes:
  postgres_local:
  jitsi_web_config:
  jitsi_web_certs:
  jitsi_prosody_config:
  jitsi_jicofo_config:
  jitsi_jvb_config:

networks:
  lms-local:
    driver: bridge
